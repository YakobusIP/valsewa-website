generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Status {
  AVAILABLE
  IN_USE
  NOT_AVAILABLE
}

model Account {
  id                     Int       @id @default(autoincrement())
  username               String
  nickname               String
  accountCode            String    @unique
  description            String?
  accountRank            String
  availabilityStatus     Status    @default(AVAILABLE)
  currentBookingDate     DateTime?
  currentBookingDuration Int?
  currentExpireAt        DateTime?
  nextBookingDate        DateTime?
  nextBookingDuration    Int?
  nextExpireAt           DateTime?
  totalRentHour          Int       @default(0)
  rentHourUpdated        Boolean   @default(false)
  password               String
  passwordResetRequired  Boolean   @default(false)
  skinList               Skin[]
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt

  priceTier   PriceTier @relation(fields: [priceTierId], references: [id])
  priceTierId Int

  thumbnail   ImageUpload? @relation("Thumbnail", fields: [thumbnailId], references: [id])
  thumbnailId Int?         @unique

  otherImages ImageUpload[] @relation("OtherImages")

  resetLogs AccountResetLog[]
  Booking   Booking[]
}

model AccountResetLog {
  id               Int       @id @default(autoincrement())
  accountId        Int
  account          Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  previousExpireAt DateTime?
  resetAt          DateTime  @default(now())
}

model PriceTier {
  id        Int      @id @default(autoincrement())
  code      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts  Account[]
  priceList PriceList[]
}

model PriceList {
  id          Int    @id @default(autoincrement())
  duration    String
  normalPrice Int
  lowPrice    Int

  tierId Int
  tier   PriceTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tierId])
}

model Skin {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  imageUrl String
  keyword  String?

  accounts Account[]
}

model ImageUpload {
  id        Int      @id @default(autoincrement())
  imageUrl  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  thumbnailOf Account? @relation("Thumbnail")

  account   Account? @relation("OtherImages", fields: [accountId], references: [id])
  accountId Int?

  slide123Of CarouselSlide? @relation("Slide123")
  slide126Of CarouselSlide? @relation("Slide126")
  slide129Of CarouselSlide? @relation("Slide129")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Booking Booking[]
}

model Customer {
  id                Int       @id @default(autoincrement())
  username          String    @unique
  password          String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  passwordChangedAt DateTime  @default(now())
  isActive          Boolean   @default(true)
  passwordExpireAt  DateTime?
}

model CarouselSlide {
  id Int @id @default(autoincrement())

  image123   ImageUpload @relation("Slide123", fields: [image123Id], references: [id])
  image123Id Int         @unique

  image126   ImageUpload @relation("Slide126", fields: [image126Id], references: [id])
  image126Id Int         @unique

  image129   ImageUpload @relation("Slide129", fields: [image129Id], references: [id])
  image129Id Int         @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ----------------------------------------------------------------------
// BOOKING-RELATED ENUMS & MODELS
// ----------------------------------------------------------------------

enum BookingStatus {
  HOLD
  RESERVED
  EXPIRED
  FAILED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  EXPIRED
  FAILED
  CANCELLED
  REFUNDED
}

enum DurationType {
  HOURLY
  DAILY
}

enum Provider {
  FASPAY
}

enum PaymentMethodType {
  QRIS
}

model Booking {
  id        String        @id @default(uuid())
  userId    Int? // optional when booking is made by an admin
  accountId Int
  status    BookingStatus @default(HOLD)

  // Duration
  baseDurationUnit Int
  baseDurationType DurationType
  quantity         Int
  immediate        Boolean
  startAt          DateTime?
  endAt            DateTime?
  expiredAt        DateTime?

  // Pricing
  mainValuePerUnit   Int
  othersValuePerUnit Int?
  voucherId          Int?
  voucherType        Type?
  voucherAmount      Float?
  voucherMaxDiscount Float?
  mainValue          Int
  othersValue        Int?
  discount           Int? // mainValue * voucher_percentage
  totalValue         Int // mainValue + otherValue - discount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  payments Payment[]
  user     User?     @relation(fields: [userId], references: [id])
  account  Account   @relation(fields: [accountId], references: [id])

  @@index([accountId, startAt, endAt]) // availability check
  @@index([userId, createdAt(sort: Desc)]) // history
  @@index([status, expiredAt]) // cleanup
}

model Payment {
  id        String        @id @default(uuid())
  bookingId String
  status    PaymentStatus
  value     Int
  currency  String        @default("IDR")

  provider          Provider
  providerPaymentId String?
  paymentMethod     PaymentMethodType?

  qrUrl String?

  paidAt        DateTime?
  refundedValue Int       @default(0)
  refundedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([bookingId]) // verify payment lookup
  @@index([providerPaymentId]) // callback lookup
}

enum Type {
  PERSENTASE
  NOMINAL
}

model Voucher {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  voucherName String   @unique
  isValid     Boolean  @default(true)
  isVisible   Boolean  @default(true)
  type        Type
  percentage  Float?
  nominal     Float?
  maxDiscount Float?
  dateStart   DateTime
  dateEnd     DateTime
}
