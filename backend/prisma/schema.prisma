generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Status {
  AVAILABLE
  IN_USE
  NOT_AVAILABLE
}

model Account {
  id                     Int       @id @default(autoincrement())
  username               String
  nickname               String
  accountCode            String    @unique
  description            String?
  accountRank            String
  availabilityStatus     Status    @default(AVAILABLE)
  currentBookingDate     DateTime?
  currentBookingDuration Int?
  currentExpireAt        DateTime?
  nextBookingDate        DateTime?
  nextBookingDuration    Int?
  nextExpireAt           DateTime?
  totalRentHour          Int       @default(0)
  rentHourUpdated        Boolean   @default(false)
  password               String
  passwordResetRequired  Boolean   @default(false)
  // skinList               String[]  // EXPAND: Temporarily added back for migration (old column)
  // skins                  Skin[]     // EXPAND: Temporarily renamed relation (was skinList)
  skinList               Skin[] // CONTRACT: Enable this once migration is complete
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  isLowRank              Boolean   @default(false)
  isRecommended          Boolean @default(false)

  priceTier   PriceTier @relation(fields: [priceTierId], references: [id])
  priceTierId Int

  thumbnail   ImageUpload? @relation("Thumbnail", fields: [thumbnailId], references: [id])
  thumbnailId Int?         @unique

  otherImages ImageUpload[] @relation("OtherImages")

  resetLogs AccountResetLog[]
  Booking   Booking[]
}

model AccountResetLog {
  id               Int       @id @default(autoincrement())
  accountId        Int
  account          Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  previousExpireAt DateTime?
  resetAt          DateTime  @default(now())
}

model PriceTier {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  // description String?  // EXPAND: Temporarily added back for migration
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  accounts  Account[]
  priceList PriceList[]
}

model PriceList {
  id          Int    @id @default(autoincrement())
  duration    String
  normalPrice Int
  lowPrice    Int

  tierId Int
  tier   PriceTier @relation(fields: [tierId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tierId])
}

model Skin {
  id       Int     @id @default(autoincrement())
  name     String  @unique
  imageUrl String
  keyword  String?

  accounts Account[]
}


enum MediaType {
  IMAGE
  VIDEO
}

model ImageUpload {
  id        Int       @id @default(autoincrement())
  imageUrl  String
  type      MediaType @default(IMAGE)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  thumbnailOf Account? @relation("Thumbnail")

  account   Account? @relation("OtherImages", fields: [accountId], references: [id])
  accountId Int?

  slideOf CarouselSlide? @relation("SlideImage")
}

model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Customer {
  id                Int       @id @default(autoincrement())
  username          String    @unique
  password          String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  passwordChangedAt DateTime  @default(now())
  isActive          Boolean   @default(true)
  passwordExpireAt  DateTime?

  Booking Booking[]
}

model CarouselSlide {
  id Int @id @default(autoincrement())

  image   ImageUpload @relation("SlideImage", fields: [imageId], references: [id])
  imageId Int         @unique

  duration Int @default(5)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


// ----------------------------------------------------------------------
// BOOKING-RELATED ENUMS & MODELS
// ----------------------------------------------------------------------

enum BookingStatus {
  HOLD
  RESERVED
  EXPIRED
  FAILED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  EXPIRED
  FAILED
  CANCELLED
  REFUNDED
}

enum Provider {
  FASPAY
  MANUAL
}

enum PaymentMethodType {
  QRIS
  VIRTUAL_ACCOUNT
  MANUAL
}

model Booking {
  id         String        @id @default(cuid())
  customerId Int? // optional when booking is made by an admin
  accountId  Int
  status     BookingStatus @default(HOLD)

  // Duration
  duration  String
  quantity  Int
  immediate Boolean
  startAt   DateTime?
  endAt     DateTime?
  expiredAt DateTime?

  // Pricing
  mainValuePerUnit   Int
  othersValuePerUnit Int?
  voucherName        String?
  voucherType        Type?
  voucherAmount      Float?
  voucherMaxDiscount Float?
  mainValue          Int
  othersValue        Int?
  discount           Int? // mainValue * voucher_percentage
  adminFee           Int?
  totalValue         Int // mainValue + otherValue + adminFee - discount

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  payments Payment[]
  customer Customer? @relation(fields: [customerId], references: [id])
  account  Account   @relation(fields: [accountId], references: [id])

  @@index([accountId, status, startAt])
  @@index([accountId, status, endAt]) // availability check
  @@index([customerId, createdAt(sort: Desc)]) // history
  @@index([status, expiredAt]) // cleanup
}

model Payment {
  id        String        @id @default(cuid())
  bookingId String
  status    PaymentStatus
  value     Int
  currency  String        @default("IDR")

  provider          Provider
  providerPaymentId String?
  paymentMethod     PaymentMethodType?

  // For PaymentMethodType = QRIS
  qrUrl String?

  // For PaymentMethodType = VIRTUAL_ACCOUNT
  bankCode        String?
  bankAccountNo   String?
  bankAccountName String?

  paidAt        DateTime?
  refundedValue Int       @default(0)
  refundedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking? @relation(fields: [bookingId], references: [id])

  @@index([bookingId, status]) // verify payment lookup
  @@index([providerPaymentId]) // callback lookup
}

enum Type {
  PERSENTASE
  NOMINAL
}

model Voucher {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  voucherName String   @unique
  isValid     Boolean  @default(true)
  isVisible   Boolean  @default(true)
  type        Type
  percentage  Float?
  nominal     Float?
  maxDiscount Float?
  dateStart   DateTime
  dateEnd     DateTime
}

model GlobalSettings {
  key   String @id
  value String
}
